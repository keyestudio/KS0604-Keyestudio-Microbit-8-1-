### 3.2.6 智能追光狗

#### 3.2.6.1 简介

![Img](./media/top1.png)

使用一些乐高积木块、Microbit V2主板，舵机扩展板和1个360°乐高舵机等，来搭建一个智能追光狗，通过Microbit V2主板上面的5×5 LED点阵屏和代码编程来控制智能追光狗追光运动。

![Img](./media/bottom1.png)

#### 3.2.6.2 元件知识

![Img](./media/2top.png)

**Microbit光线接收**

![Img](./media/j101.png)

micro:bit V2主板并不自带光敏传感器，它对外界光照强度的检测是通过5×5 LED点阵屏进行的，是利用5×5 LED点阵屏作为光接收元件。5×5 LED点阵屏被用来感知周围的光，并反复地将光照强度通过5×5 LED点阵屏转换成输入，并采样电压衰减时间，这样检测出来的光照强度是一个相对值。（**注意：** 将光线亮度输出至串口，输出的是一个相对值。）

![Img](./media/2bottom.png)

#### 3.2.6.3 所需组件

![Img](./media/A6-0.png)

#### 3.2.6.4 积木搭建

![Img](./media/2top.png)

![Img](./media/A6-1.png)

![Img](./media/A6-2.png)

![Img](./media/A6-3.png)

![Img](./media/A6-4.png)

![Img](./media/A6-5.png)

![Img](./media/A6-6.png)

![Img](./media/A6-7.png)

![Img](./media/A6-8.png)

![Img](./media/A6-9.png)

![Img](./media/A6-10.png)

![Img](./media/A6-11.png)

![Img](./media/A6-12.png)

![Img](./media/A6-13.png)

![Img](./media/A6-14.png)

![Img](./media/A6-15.png)

![Img](./media/A6-16.png)

![Img](./media/A6-17.png)

![Img](./media/A6-18.png)

![Img](./media/A6-19.png)

![Img](./media/A6-20.png)

![Img](./media/A6-21.png)

![Img](./media/A6-22.png)

![Img](./media/A6-23.png)

![Img](./media/A6-24.png)

![Img](./media/A6-25.png)

![Img](./media/A6-26.png)

![Img](./media/A6-27.png)

![Img](./media/A6-28.png)

**电池盒中安装好4个AAA-1.5V电池（电池电源充足）**

![Img](./media/A00.png)

![Img](./media/A6-29.png)

![Img](./media/A6-30.png)

**乐高舵机接线**

| 乐高舵机 | 舵机扩展板引脚(SERVO2/P2) | micro:bit V2主板引脚 |
| :-----: | :----------------------: | :--------------: |
|   棕线   |           GND            |         G        |
|   红线   |           VCC            |         V        |
|  橙黄线  |          SIG(S)          |         P2       |

![Img](./media/wiring6.png)

![Img](./media/A6-31.png)

![Img](./media/2bottom.png)

#### 3.2.6.5 代码流程图

```mermaid
flowchart TD
    Start([开始]) --> OnInit1[初始化]
    OnInit1 --> OnInit2[设置SK6812 RGB LED的引脚为P0<br>设置SK6812 RGB LED亮度为30%<br>SK6812 RGB LED不亮]
    OnInit2 --> Forever[进入主循环]
    Forever --> Conditionals{micro:bit V2主板上面的5×5 LED点阵屏检测光线等级}
    Conditionals -- 光线等级 ≥ 150 --> Conditionals1[高亮条件]
    Conditionals1 -->|是| EventA[1\. SK6812 RGB LED亮红色灯<br>2\. 5×5 LED点阵屏显示“音乐”图案<br>3\. 智能追光狗随光后退]
    EventA --> Conditionals
    Conditionals -- 10 < 光线等级 < 150 --> Conditionals2[中等亮度条件]
    Conditionals2 -->|是| EventB[1\. SK6812 RGB LED亮青色灯<br>2\. 5×5LED点阵屏显示“高兴”图案<br>3\. 智能追光狗随光前进]
    EventB --> Conditionals
    Conditionals -- 光线等级 ≤ 10 --> Conditionals3[低亮/黑暗条件]
    Conditionals3 -->|是| EventC[1\. SK6812 RGB LED熄灭<br>2\. 5×5 LED点阵屏清屏<br>3\. 智能追光狗停止]
    EventC --> Conditionals
```

#### 3.2.6.6 指令方块说明

1\. “on start”代码块中的代码将仅执行一次。

![Img](./media/on-start.png)

2\. “forever”代码块中的代码将循环执行.

![Img](./media/forever.png)

3\. 设置micro:bit主板上面的5×5 LED点阵屏显示图案.

![Img](./media/55LED.png)

4\. 设置SK6812 RGB LED的引脚和点亮RGB LED颗粒数.

![Img](./media/RGBLED.png)

5\. 设置SK6812 RGB LED 的亮度.

![Img](./media/RGBLED1.png)

6\. 设置SK6812 RGB LED 都不亮。

![Img](./media/RGBclear.png)

7\. 设置SK6812 RGB LED点亮的颜色灯.

![Img](./media/color.png)

8\. 这是if()...else...的判断语句。

如果if()中的条件成立时，则运行then下面的语句；否则，if()中的条件不成立，则运行else下面的语句。

![Img](./media/if-else.png)

9\. 设置360°舵机的引脚，转动方向(顺时针/逆时针)和转动的速度(0~100%)。

![Img](./media/360Servo.png)

10\. micro:bit V2主板上面的5×5 LED点阵屏清屏。

![Img](./media/55LEDClear.png)

11\. 读取照射在micro:bit V2主板上面5×5 LED点阵屏上的光照强度，范围从“0”（较暗）到“255”（明亮）。

![Img](./media/lightlevel.png)

12\. 这个指令方块，适用于形成判断表达式的，使用时将需要判断的两个数值或者变量模块添加到方块两端。

![Img](./media/img18.png)

![Img](./media/img02.png)

#### 3.2.6.7 实验代码

![Img](./media/couj06.png)

⚠️ **<span style="color: rgb(255, 76, 65);">特别提醒：可以通过以下两种方法获取实验代码。</span>**

##### **方法一：拖动代码块编写代码**

**1. MakeCode编程环境：**

打开MakeCode编辑器在线网页版本: [MakeCode](https://makecode.microbit.org/#editor)

**2. 添加专属扩展库**

⚠️ **<span style="color: rgb(255, 76, 65);">特别提醒:</span>** 将链接：`https://github.com/keyestudio2019/pxt-creative-inventors-kit-master.git` 复制粘贴到页面的搜索框中。

![Img](./media/Animation-4.gif)

**3. 编写代码**

![Img](./media/dongtu-06.gif)

##### **方法二：直接下载示例代码**

**1. 下载示例代码：**

单击下载代码：[3_3_6_Smart_Light_Following_Dog](./Codes/3_3_6_Smart_Light_Following_Dog.hex)

**2. MakeCode编程环境：**

打开MakeCode编辑器在线网页版本: [MakeCode](https://makecode.microbit.org/#editor)

**3. 导入示例代码：**

将下载好的示例代码拖入MakeCode编辑器中。

![Img](./media/Animation-0006.gif)

![Img](./media/line1.png)

**简单说明：**

① 初始化SK6812 RGB LED的引脚P0和点亮RGB LED颗粒数，RGB LED的亮度，RGB LED全不亮。

![Img](./media/cou06.png)

② 在“forever”代码块中，有一个if()...else if()...else...的判断语句。

如果micro:bit V2主板上面的5×5 LED点阵屏检测到光线等级 ≥ 150 时，智能追光狗随光后退，同时SK6812 RGB LED亮红色灯，micro:bit V2主板上面的5×5 LED点阵屏显示图案![Img](./media/ab5.png)。

![Img](./media/cou16.png)

否则如果，micro:bit V2主板上面的5×5 LED点阵屏检测到 10 < 光线等级 < 150 时，智能追光狗随光前进，同时SK6812 RGB LED亮青色灯，micro:bit V2主板上面的5×5 LED点阵屏显示图案![Img](./media/ab3.png)。

![Img](./media/cou17.png)

否则，micro:bit V2主板上面的5×5 LED点阵屏检测到光线等级 ≤ 10时，智能追光狗停止，同时SK6812 RGB LED熄灭，micro:bit V2主板上面的5×5 LED点阵屏清屏。

![Img](./media/cou18.png)

#### 3.2.6.8 实验结果

![Img](./media/4top.png)

按照接线图接好线，利用micro USB数据线上电，同时还需要外接电源 (4个AAA电池安装到电池盒，且保证电源充足)。

使用在线浏览器下载示例代码，则需要将下载好的 “.hex” 文件发送到micro:bit主板上。如下两种情况：

**① 下载示例代码(WebUSB功能)**

使用 **Google Chrome** 或  **Microsoft Edge浏览器**，需要先进行设备配对，再将示例代码下载到micro:bit V2主板上。

![Img](./media/Animation-06.gif)

**② 下载示例代码(非WebUSB功能)**

 如果是使用其他浏览器（如：非Google Chrome 或 非Microsoft Edge浏览器），将示例代码下载、发送到micro:bit V2主板上。

![Img](./media/Animation-006.gif)

将示例代码成功下载、发送到micro:bit V2主板之后，然后将micro USB数据线从micro:bit V2主板上拔下来。

将舵机扩展板上的左侧拨码开关拨到RGB端，右侧拨码开关拨到ON端。

![Img](./media/CBA01.png)

移动光源（或者打开手机照明）照射到micro:bit上面的5×5 LED点阵屏。

当micro:bit V2主板上面的5×5 LED点阵屏检测到光线等级 ≥ 150时，智能追光狗随光后退，同时SK6812 RGB LED亮红色灯，micro:bit V2主板上面的5×5 LED点阵屏显示图案![Img](./media/ab5.png)；

当micro:bit V2主板上面的5×5 LED点阵屏检测到 10 < 光线等级 < 150时，智能追光狗随光前进，同时SK6812 RGB LED亮青色灯，micro:bit V2主板上面的5×5 LED点阵屏显示图案![Img](./media/ab3.png)；

当micro:bit V2主板上面的5×5 LED点阵屏检测到光线等级 ≤ 10时，智能追光狗停止，同时SK6812 RGB LED熄灭，micro:bit V2主板上面的5×5LED点阵屏清屏。

![Img](./media/dongtu-006.gif)   

![Img](./media/4bottom.png)
